"use strict";angular.module("berlinerSchulenApp",["leaflet-directive","ui.router","ngMaterial","lumx","mdDateTime"]),angular.module("berlinerSchulenApp").config(["$stateProvider","$urlRouterProvider","$mdThemingProvider",function(a,b,c){c.theme("default").primaryPalette("teal").accentPalette("pink").warnPalette("red").backgroundPalette("blue-grey"),b.otherwise("/"),a.state("index",{url:"/",views:{view1:{controller:"FilterCtrl",templateUrl:"filterAndMap/filterAndMap.html"},view2:{controller:"ListCtrl",templateUrl:"list/list.html"}}}).state("school",{url:"/school/{BSN:[0-9]{2}[A-Z][0-9]{2}}",views:{view1:{controller:"SchoolCtrl",templateUrl:"school/school.html"}}}).state("statistics",{url:"/statistics",views:{view1:{controller:"StatisticsCtrl",templateUrl:"statistics/statistics.html"}}}).state("imprint",{url:"/impressum",views:{view1:{controller:"AboutCtrl",templateUrl:"about/about.html"}}})}]),angular.module("berlinerSchulenApp").factory("schoolFactory",["$http","$rootScope",function(a,b){var c={content:null},d={content:null},e={},f=[],g=[],h=[],i={},j=!0;return d.initFilter=function(){return{main:"",districts:[],startDate:(new Date).setHours(0,0,0,0),endDate:void 0}},d.addFilterCallback=function(a,b){f.push({field:a,cb:b})},d.addSchoolCallback=function(a,b){g.push({id:a,cb:b})},d.addRunFilterCallback=function(a){h.push(a)},d.setFirstRun=function(a){j=a},d.isFirstRun=function(){return j},d.setFilter=function(a){for(var b in a)switch(b){case"main":d.isFirstRun()?(e.main="",d.setFirstRun(!1)):e.main=a.main.toLowerCase();break;case"districts":e.districts=a.districts;break;case"startDate":e.startDate=a.startDate;break;case"endDate":e.endDate=a.endDate}return d},d.getFilter=function(){return angular.copy(e)},d.applyFilter=function(){if(null===c.content)return null;var a=c.content.filter(function(a){if(void 0!==a.name){var b=a.name.toLowerCase();if(b.indexOf(e.main)>-1)return!0}if(void 0!==a.location){var c=a.location.toLowerCase();if(c.indexOf(e.main)>-1)return!0}if(void 0!==a.host){var d=a.host.toLowerCase();if(d.indexOf(e.main)>-1)return!0}return!1}).filter(function(a){if(e.districts.length>0){for(var b in e.districts){var c=e.districts[b].name;if(""!==c&&a.county.indexOf(c)>-1)return!0}return!1}return!0}).filter(function(a){if(void 0!=e.startDate){var b=a.to.split("."),c=new Date(b[2],b[1]-1,b[0]);return e.startDate>c?!1:!0}return!0}).filter(function(a){if(void 0!=e.endDate){var b=a.from.split("."),c=new Date(b[2],b[1]-1,b[0]);return e.endDate<c?!1:!0}return!0});return d.content=a,d.publishData(),d.isFirstRun()&&d.setFirstRun(!1),d},d.publishData=function(){b.$broadcast("updateSchools",d.content)},d.getJson=function(){a.get("data/events.json").success(function(a){c.content=a,d.content=a,d.applyFilter(),f.length>0&&d.populateFilterChoices(),g.length>0&&d.populateSchoolDetails(),h.length>0&&h.call(this)})},d.populateFilterChoices=function(){for(var a=[],b=f.length-1;b>=0;b--)a.push([]);for(b=c.content.length-1;b>=0;b--)for(var e=f.length-1;e>=0;e--){var g="",h=f[e].field,i=c.content[b];switch(h){case"county":void 0!==i.county&&(g=i.county);break;default:g=""}if(g.constructor===Array||a[e].contains(g)){if(g.constructor===Array)for(var j=g.length-1;j>=0;j--)a[e].contains(g[j])||a[e].push(g[j])}else a[e].push(g)}for(b=f.length-1;b>=0;b--)d.saveChoices(f[b].field,a[b]),f[b].cb.call(this,a[b])},d.saveChoices=function(a,b){switch(a){case"county":i.county=b}},d.getChoiceByName=function(a){switch(a){case"county":return i.county;default:return[]}},d.populateSchoolDetails=function(){if(null!==c.content)for(var a=g.length-1;a>=0;a--){var b=g[a].id,e=d.getSchoolByID(b);g[a].cb.call(this,e)}},d.getSchoolByID=function(a){for(var b=c.content.length-1;b>=0;b--)if(c.content[b].id===a)return c.content[b];return{}},d.hasData=function(){return null!==c.content},e=d.initFilter(),d.getJson(),d}]),Array.prototype.contains=function(a){for(var b=this.length;b--;)if(this[b]===a)return!0;return!1},angular.module("berlinerSchulenApp").controller("FilterCtrl",["$scope","$timeout","$mdSidenav","schoolFactory","$filter","LxDialogService",function(a,b,c,d,e,f){var g=e("orderBy");a.searchFilter={main:"",districts:[],startDate:(new Date).setHours(0,0,0,0),endDate:void 0},a.loading=!1,a.filter=function(){a.loading=!0,b(function(){d.setFilter(a.searchFilter).applyFilter(),a.loading=!1},600)},a.openCal=function(a){f.open(a)},a.closeCal=function(a){f.close(a)},a.resetFilter=function(){a.cbDistricts.selectedDistricts=[],a.cbDate.selectedStartDate=(new Date).setHours(0,0,0,0),a.cbDate.selectedStartDate=void 0,a.cbDate.startDateString=moment(a.cbDate.selectedStartDate).format("DD.MM.YYYY"),a.cbDate.endDateString="",a.searchFilter={main:"",districts:[],startDate:(new Date).setHours(0,0,0,0),endDate:void 0},a.filter()},a.cbDistricts={districts:[],selectedDistricts:[],loading:!1,exec:function(b){a.searchFilter.districts=b.newValue,a.filter()},populate:function(b){var c=[];for(var d in b)c.push({name:b[d]});a.cbDistricts.districts=g(c,"name",!1),a.cbDistricts.loading=!1},addCallback:function(){a.cbDistricts.loading=!0,d.addFilterCallback("county",this.populate)}},a.cbDate={selectedStartDate:(new Date).setHours(0,0,0,0),selectedEndDate:void 0,startDateString:"",endDateString:"",loading:!1,execStart:function(b){b.setHours(0,0,0,0),a.cbDate.startDateString=moment(b).format("DD.MM.YYYY"),a.searchFilter.startDate=b,a.filter(),a.closeCal("startCal")},execEnd:function(b){b.setHours(23,59,59,999),a.cbDate.endDateString=moment(b).format("DD.MM.YYYY"),a.searchFilter.endDate=b,a.filter(),a.closeCal("endCal")},populate:function(){a.cbDate.loading=!1},addCallback:function(){a.cbDate.loading=!0,d.addFilterCallback("from",this.populate)}},this.setSearchFilter=function(b){a.searchFilter=b,a.cbDistricts.selectedDistricts=b.districts,a.cbDate.selectedStartDate=(new Date).setHours(0,0,0,0),a.cbDate.selectedEndDate=void 0,a.cbDate.startDateString=moment(a.cbDate.selectedStartDate).format("DD.MM.YYYY")},this.runFilter=function(){if(this.setSearchFilter(d.getFilter()),d.hasData()){var b=d.getChoiceByName("county");a.cbDistricts.populate(b),a.cbDate.populate(),a.filter()}else a.cbDistricts.addCallback(),a.cbDate.addCallback(),d.setFilter(a.searchFilter)},this.runFilter()}]),angular.module("berlinerSchulenApp").controller("MapCtrl",["$scope","$rootScope","$timeout","schoolFactory","$window",function(a,b,c,d,e){angular.extend(a,{defaults:{maxZoom:17,scrollWheelZoom:!1,zoomControl:!0,zoomControlPosition:"topright"},layers:{baselayers:{mapbox:{name:"Mapbox",url:"http://api.tiles.mapbox.com/v4/obstschale.kp8hf045/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoib2JzdHNjaGFsZSIsImEiOiJvSFdVbmRRIn0.2aQ9TaMbMbyrAuFQh_icXg",type:"xyz"},osm:{name:"OpenStreetMap",url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",type:"xyz",layerOptions:{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}}},overlays:{schools:{name:"Feste",type:"markercluster",visible:!0}}},events:{map:{enable:[],logic:"emit"},marker:{enable:[],logic:"emit"}},berlin:{lat:52.5153601,lng:13.3833154,zoom:11},data:{},icons:{blue_icon:{iconUrl:"assets/img/circle_blue_borderless.svg",iconSize:[15,15],iconAnchor:[7,7],popupAnchor:[0,-5]},orange_icon:{iconUrl:"assets/img/circle_orange_borderless.svg",iconSize:[15,15],iconAnchor:[7,7],popupAnchor:[0,-5]},bluegrey_icon:{iconUrl:"assets/img/circle_bluegrey_borderless.svg",iconSize:[15,15],iconAnchor:[7,7],popupAnchor:[0,-5]},cyan_icon:{iconUrl:"assets/img/circle_cyan_borderless.svg",iconSize:[15,15],iconAnchor:[7,7],popupAnchor:[0,-5]},green_icon:{iconUrl:"assets/img/circle_green_borderless.svg",iconSize:[15,15],iconAnchor:[7,7],popupAnchor:[0,-5]},red_icon:{iconUrl:"assets/img/circle_red_borderless.svg",iconSize:[15,15],iconAnchor:[7,7],popupAnchor:[0,-5]}}});var f=a.$on("updateSchools",function(b,c){function d(a){return a===+a&&a!==(0|a)}a.data.markers={};for(var e=0;e<c.length;e++){var f=null,g=null;if(void 0!==c[e]&&(f=parseFloat(c[e].lat),g=parseFloat(c[e].lon)),d(f)&&d(g)){var h="<strong>"+c[e].name+"</strong><br>";h+="<em>Ort:</em> ",""!=c[e].location&&(h+=c[e].location+", "),""!=c[e].zip&&(h+=c[e].zip+", "),h+=c[e].county+"<br>",h+="<em>Datum:</em> "+c[e].from+" bis "+c[e].to+"<br>",h+="<em>Zeit:</em> "+c[e].time+"<br>",h+="<em>Eintritt:</em> "+c[e].fee+"<br><br>",h+="<em>Veranstalter:</em> "+c[e].host+"<br>",""!=c[e].tel&&(h+="<em>Tel:</em> "+c[e].tel+"<br>"),""!=c[e].mail&&(h+='<em>Mail:</em> <a href="mailto:'+c[e].mail+'">'+c[e].mail+"</a><br>"),""!=c[e].website&&(h+='<em>Website:</em> <a href="http://'+c[e].website+'" target="_blank">'+c[e].website+"</a><br>"),""!=c[e].comments&&(h+="<br><em>Bemerkungen:</em> "+c[e].comments);var i={lat:f,lng:g,compileMessage:!1,message:h,id:c[e].id,layer:"schools"};switch(c[e].fee){case"K.A.":i.icon=a.icons.orange_icon;break;case"Eintritt frei":i.icon=a.icons.green_icon;break;default:i.icon=a.icons.red_icon}a.data.markers[c[e].id]=i}}});a.$on("destroy",f);var g=angular.element(e),h=-1;a.getMinMapHeight=function(){return-1===h&&(h=1*g.height()),h};var i=a.$on("mapCenterRequest",function(a,b,c,d){a.currentScope.berlin.lat=b,a.currentScope.berlin.lng=c;for(var e in a.currentScope.data.markers){var f=a.currentScope.data.markers[e];if(f.id===d){f.focus=!0;break}}});a.$on("destroy",i)}]),angular.module("berlinerSchulenApp").controller("ListCtrl",["$scope","$rootScope",function(a,b){function c(a){return a===+a&&a!==(0|a)}a.schools=[],a.pageSize=10,a.currentPage=0,a.centerMap=function(a){var d=parseFloat(a.lat),e=parseFloat(a.lon),f=a.bsn;c(d)&&c(e)&&b.$broadcast("mapCenterRequest",d,e,f)},a.numberOfPages=function(){return Math.ceil(a.schools.length/a.pageSize)};var d=a.$on("updateSchools",function(b,c){a.currentPage=0,a.schools=[];var d=[],f={red:{src:"assets/img/circle_red_borderless.svg"},green:{src:"assets/img/circle_green_borderless.svg"},orange:{src:"assets/img/circle_orange_borderless.svg"}};if(c.length>0){for(var g=c.length-1;g>=0;g--){var h={name:c[g].name,district:c[g].county,street:c[g].location,zip:c[g].zip,date:c[g].from+" bis "+c[g].to,url:c[g].website,lat:c[g].lat,lon:c[g].lon};switch(c[g].fee){case"K.A.":h.icon=f.orange;break;case"Eintritt frei":h.icon=f.green;break;default:h.icon=f.red}d.push(h)}e(d)}});a.$on("destroy",d);var e=function(b){a.schools=b}}]),angular.module("berlinerSchulenApp").filter("startFrom",function(){return function(a,b){return"undefined"!=typeof a&&"undefined"!=typeof b?(b=+b,a.slice(b)):null}}),angular.module("berlinerSchulenApp").controller("AboutCtrl",["$scope","LxDialogService","LxNotificationService",function(a,b,c){a.opendDialog=function(a){b.open(a)},a.closingDialog=function(){c.info("Dialog closed!")}}]),angular.module("berlinerSchulenApp").controller("SchoolCtrl",["$scope","$stateParams","schoolFactory","LxProgressService",function(a,b,c,d){a.loaded=!1,a.err=!1,angular.extend(a,{defaults:{tileLayer:"http://api.tiles.mapbox.com/v4/obstschale.kp8hf045/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoib2JzdHNjaGFsZSIsImEiOiJvSFdVbmRRIn0.2aQ9TaMbMbyrAuFQh_icXg",maxZoom:15,path:{weight:10,color:"#800000",opacity:1},scrollWheelZoom:!1,zoomControl:!1,dragging:!1,touchZoom:!1,doubleClickZoom:!1},berlin:{lat:52.5153601,lng:13.3833154,zoom:15},icons:{blue_icon:{iconUrl:"assets/img/circle_blue.svg",iconSize:[20,20],iconAnchor:[7,7],popupAnchor:[0,-5]},orange_icon:{iconUrl:"assets/img/circle_orange.svg",iconSize:[20,20],iconAnchor:[7,7],popupAnchor:[0,-5]},bluegrey_icon:{iconUrl:"assets/img/circle_bluegrey.svg",iconSize:[20,20],iconAnchor:[7,7],popupAnchor:[0,-5]},cyan_icon:{iconUrl:"assets/img/circle_cyan.svg",iconSize:[20,20],iconAnchor:[7,7],popupAnchor:[0,-5]},green_icon:{iconUrl:"assets/img/circle_green.svg",iconSize:[20,20],iconAnchor:[7,7],popupAnchor:[0,-5]},red_icon:{iconUrl:"assets/img/circle_red.svg",iconSize:[20,20],iconAnchor:[7,7],popupAnchor:[0,-5]}},data:{markers:{m1:{lat:52.5153601,lng:13.3833154,compileMessage:!1,message:"Das ist Berlin. Für den Fall, dass<br>du das noch nicht wusstest :)",icon:{}}}}}),a.school={},a.loadSchool=function(c){if(void 0===c.id)return d.circular.hide(),a.school.id=b.ID,a.err=!0,0;a.loaded=!0,d.circular.hide(),a.school=c,a.school.tel=c.tel,a.school.location=c.location;var e,f;if(void 0!==c.lat||void 0!==c.lon){e=parseFloat(c.lat),f=parseFloat(c.lon),a.berlin.lat=e,a.berlin.lng=f,a.data.markers.m1.lat=e,a.data.markers.m1.lng=f;var g=null;g=a.icons.blue_icon,angular.extend(a.data.markers.m1,{icon:g})}},this.addCallback=function(){a.school={};var d=b.ID;c.addSchoolCallback(d,a.loadSchool)},d.circular.show("#5fa2db","#feedback"),this.addCallback(),c.populateSchoolDetails()}]),angular.module("berlinerSchulenApp").controller("StatisticsCtrl",["$scope","$http",function(a,b){a.text="More Statistics Comming Soon ..."}]);